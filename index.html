<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MathSemantifier</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/MathSemantifier.css" rel="stylesheet">
</head>

<body>
    <div id="MathSemantifier" class="row">
        <div class="col-xs-1"></div>
        <div class="col-xs-6">
            <h3 id="title">Math Semantifier</h3>
            <div id="textarea">
                <textarea id="editor" rows="10" cols="60">
                    <mo>i</mo>
                    <mo>‚Å¢</mo>
                    <mn>2</mn>
                    <mo>+</mo>         
                    <mi>x</mi>
                    <mo>mod</mo>
                    <mn>5</mn>
                </textarea>
            </div>
            <h4 id="live-preview">MathML Preview</h4>
            <div id="mathml" class="preview">
            </div>

            <input type="checkbox" id="term-sharing" name="term-sharing" /> Use term sharing <br/>
            <a id="semantify" class="btn btn-lg btn-success" href="#" role="button">Semantify MathML</a>
            <a id="semantic-tree" class="btn btn-lg btn-success" href="#" role="button">Show Semantic Tree</a>
            <div id="results" class="">
            </div>
        </div>
    </div>
    <script src="js/jquery.min.js" >
</script>
    <script src="js/bootstrap.min.js" >
</script>
    <script src="js/MathSemantifier.js" >
</script>

<script>


var parsingEngineURL = "http://localhost:3000";
var mmtURL = "http://localhost:8081";
var globalData = {};

function math(str) {
    return `<math xmlns="http://www.w3.org/1998/Math/MathML">` + str + `</math>`
}
var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
};

function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function(s) {
        return entityMap[s];
    });
}

$(document).ready(function() {
    window.setInterval(function() {
        $("#mathml").html(math($("#editor").val()));
    }, 500);
    $("#semantify").click(function() {
        var input = $("#editor").val();
        console.log("Input length is " + input.length);
        var encodedInput = encodeURIComponent(input);
        $.post(parsingEngineURL + "/detect_notations", 
        encodedInput, 
        processNotPositions);
    });
    
    
    readingBtnTmpl = index=>`
      <button index="${index}" class="semantic-tree-reading btn btn-default">
      Reading ${index + 1}
      </button>
    `
    
    $("#semantic-tree").click(function() {
        var input = $("#editor").val();
        var encodedInput = encodeURIComponent(input);
        $.ajax({
            url: mmtURL + "/:marpa/getSemanticTree?=",
            type: 'POST',
            data: {
                input: encodedInput,
                termSharing: $('#term-sharing').prop('checked')
            },
            contentType: "text/plain",
            success: function(data) {
                $("#results").empty();
                $.each(data, function(ind, reading) {
                    console.log(reading);
                    reading = escapeHtml(reading)
                    readingBtn = readingBtnTmpl(ind)
                    $("#results").append(readingBtn)
                    $("#results").append("</br><span>" + reading + "</span><br/><br/>")
                });
                installSemanticTreeBtnHandler(data);
            }
        });
    })
    
    function installSemanticTreeBtnHandler(data) {
        $(".semantic-tree-reading").click(function() {
            index = $(this).attr('index')
            console.log("Index = " + index + " selected")
            $("#editor").val(data[index]);
            $("#results").empty();
            data = {};
        })
    }

});
</script>

</body>
</html>
